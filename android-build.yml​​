name: Android APK æ„å»º (NDK 28c + API 31 + ä¼˜åŒ–é…ç½®)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  # ä½¿ç”¨æ‚¨æŒ‡å®šçš„ç‰ˆæœ¬
  NDK_VERSION: "28c"
  ANDROID_API: 31
  MIN_API: 21
  BUILD_TOOLS: "34.0.0"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½ä»£ç å’Œé…ç½®æ–‡ä»¶
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          zip unzip openjdk-17-jdk \
          autoconf automake libtool \
          libffi-dev libssl-dev git wget make

    - name: å®‰è£…Buildozerå’ŒCython
      run: pip install buildozer Cython

    - name: è®¾ç½®Androidç¯å¢ƒ (NDK r28c)
      run: |
        # ä¸‹è½½å’Œè®¾ç½®Android SDK
        wget https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
        unzip commandlinetools-linux-8512546_latest.zip
        mkdir -p android-sdk/cmdline-tools/latest
        mv cmdline-tools/* android-sdk/cmdline-tools/latest/
        
        # æ¥å—è®¸å¯åè®®
        yes | android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses
        
        # å®‰è£…å¿…è¦çš„ç»„ä»¶
        android-sdk/cmdline-tools/latest/bin/sdkmanager \
          "platforms;android-${{ env.ANDROID_API }}" \
          "build-tools;${{ env.BUILD_TOOLS }}" \
          "platform-tools"
        
        # ä¸‹è½½å’Œè®¾ç½® NDK r28c
        wget https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip
        unzip android-ndk-${{ env.NDK_VERSION }}-linux.zip
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$GITHUB_WORKSPACE/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        echo "PATH=$GITHUB_WORKSPACE/android-sdk/platform-tools:$GITHUB_WORKSPACE/android-ndk-${{ env.NDK_VERSION }}:$PATH" >> $GITHUB_ENV

    - name: æ„å»ºAPK (ä½¿ç”¨ä¼˜åŒ–é…ç½®)
      run: |
        # ä½¿ç”¨verboseæ¨¡å¼ä¾¿äºè°ƒè¯•
        buildozer -v android debug
        
        # æ£€æŸ¥æ˜¯å¦ç”ŸæˆAPK
        if [ ! -f "bin/*.apk" ]; then
            echo "âŒ APKæ–‡ä»¶æœªç”Ÿæˆï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
            exit 1
        fi

    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        APK_FILE=$(find . -name "*.apk" | head -1)
        echo "âœ… APKæ„å»ºæˆåŠŸ!"
        echo "ğŸ“¦ æ–‡ä»¶: $APK_FILE"
        echo "ğŸ“ å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
        
        # éªŒè¯APIçº§åˆ«
        aapt dump badging "$APK_FILE" | grep -E "(targetSdkVersion|minSdkVersion)" || echo "âš ï¸ aaptéªŒè¯ä¸å¯ç”¨"

    - name: ä¸Šä¼ APKäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-optimized
        path: bin/*.apk
        retention-days: 7
        compression-level: 6
        if-no-files-found: error

    - name: å®Œæˆé€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ ä¼˜åŒ–æ„å»ºå®Œæˆ!"
        echo "âœ… NDK r28c + API 31 é…ç½®"
        echo "âœ… 16Kå†…å­˜å¯¹é½ä¼˜åŒ–"
        echo "âœ… AndroidXç°ä»£æ¶æ„æ”¯æŒ"
        echo "âœ… æ€§èƒ½ç¼–è¯‘ä¼˜åŒ–"
        echo "ğŸ“¦ APKå¯åœ¨Artifactsä¸­ä¸‹è½½"
