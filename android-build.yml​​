name: Android APK Builder (NDK 28c + API 31 + ä¼˜åŒ–é…ç½®)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  NDK_VERSION: "28c"
  ANDROID_API: 31
  MIN_API: 21
  BUILD_TOOLS: "34.0.0"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½ä»£ç å’Œé…ç½®æ–‡ä»¶
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          zip unzip openjdk-17-jdk \
          autoconf automake libtool \
          libffi-dev libssl-dev git wget make

    - name: å®‰è£…Buildozerå’ŒCython
      run: pip install buildozer Cython

    - name: è®¾ç½®Androidç¯å¢ƒ (NDK r28c)
      run: |
        # åˆ›å»ºAndroid SDKç›®å½•
        mkdir -p android-sdk
        
        # ä¸‹è½½Androidå‘½ä»¤è¡Œå·¥å…·ï¼ˆä½¿ç”¨å¯é ç‰ˆæœ¬ï¼‰
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d android-sdk/cmdline-tools
        mv android-sdk/cmdline-tools/cmdline-tools android-sdk/cmdline-tools/latest
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "ANDROID_HOME=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        echo "PATH=$GITHUB_WORKSPACE/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV
        
        # æ¥å—è®¸å¯åè®®
        yes | sdkmanager --licenses
        
        # å®‰è£…å¿…è¦çš„Androidç»„ä»¶
        sdkmanager "platforms;android-${{ env.ANDROID_API }}" \
                   "build-tools;${{ env.BUILD_TOOLS }}" \
                   "platform-tools" \
                   "emulator"
        
        # ä¸‹è½½NDK r28cï¼ˆä½¿ç”¨å®˜æ–¹å¯é åœ°å€ï¼‰
        wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip -O ndk.zip
        unzip -q ndk.zip
        echo "ANDROID_NDK_HOME=$GITHUB_WORKSPACE/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        echo "PATH=$GITHUB_WORKSPACE/android-ndk-${{ env.NDK_VERSION }}:$PATH" >> $GITHUB_ENV

    - name: æ„å»ºAPK (ä½¿ç”¨ä¼˜åŒ–é…ç½®)
      run: |
        # ä½¿ç”¨verboseæ¨¡å¼ä¾¿äºè°ƒè¯•
        buildozer -v android debug
        
        # æ£€æŸ¥æ˜¯å¦ç”ŸæˆAPK
        if ls bin/*.apk 1> /dev/null 2>&1; then
            echo "âœ… APKæ–‡ä»¶å·²ç”Ÿæˆ"
        else
            echo "âŒ APKæ–‡ä»¶æœªç”Ÿæˆï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
            exit 1
        fi

    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        APK_FILE=$(find bin -name "*.apk" | head -1)
        if [ -f "$APK_FILE" ]; then
            echo "âœ… APKæ„å»ºæˆåŠŸ!"
            echo "ğŸ“¦ æ–‡ä»¶: $APK_FILE"
            echo "ğŸ“ å¤§å°: $(du -h "$APK_FILE" | cut -f1)"
        else
            echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶"
            exit 1
        fi

    - name: ä¸Šä¼ APKäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-optimized
        path: bin/*.apk
        retention-days: 7

    - name: å®Œæˆé€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ ä¼˜åŒ–æ„å»ºå®Œæˆ!"
        echo "âœ… NDK r28c + API 31 é…ç½®"
        echo "âœ… Android SDK ç»„ä»¶å·²å®‰è£…"
        echo "ğŸ“¦ APKå¯åœ¨Artifactsä¸­ä¸‹è½½"
